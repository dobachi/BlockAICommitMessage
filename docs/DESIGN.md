# AIコミットメッセージブロックツール設計書

## 1. 概要

AIが生成したコミットメッセージを検出・ブロックし、人間らしいコミットメッセージの作成を支援するツール群です。

### 目的
- AI生成コミットメッセージの自動検出と拒否
- 人間らしい自然なコミットメッセージ作成の支援
- Git workflowへのシームレスな統合

## 2. コンポーネント構成

```
BlockAICommitMessage/
├── scripts/
│   ├── detect-ai-message.sh      # AI検出エンジン
│   ├── clean-commit.sh           # クリーンコミット支援
│   ├── setup-hooks.sh            # Git hook設定
│   └── lib/
│       └── ai-patterns.sh        # AIパターン定義
├── hooks/
│   ├── pre-commit                # コミット前検証
│   └── prepare-commit-msg        # メッセージ検証
├── config/
│   └── ai-detection.conf         # 検出設定
└── docs/
    ├── README.md                 # 使用方法
    └── DESIGN.md                 # 本設計書
```

## 3. 機能設計

### 3.1 AI検出エンジン (`detect-ai-message.sh`)

**目的**: AIが生成したコミットメッセージを高精度で検出

**検出方法**:

1. **シグネチャ検出**: 明示的なAIマーカー
   - 絵文字: 🤖, 🤖 Generated with
   - 署名: Co-Authored-By: Claude/GPT/Gemini/Copilot
   - メールアドレス: noreply@anthropic.com, noreply@openai.com
   - タグ: [AI], [Bot], Generated by AI, AI-generated

2. **パターンマッチング**: AIの典型的な文体パターン
   - 過度に整形されたConventional Commits
   - "This commit..." で始まる説明的な文
   - 箇条書きの多用（3項目以上）
   - 定型的な表現パターン

3. **統計的分析**: 文の構造と複雑さ
   - 完璧な文法と句読点の使用
   - 文の長さと構造の均一性
   - 段落構成の規則性

4. **ヒューリスティック分析**: 語彙と表現
   - 形式的な動詞の頻度（enhance, optimize, streamline等）
   - 技術用語の密度
   - 受動態の使用率

### 3.2 クリーンコミット支援 (`clean-commit.sh`)

**機能**:

1. **インタラクティブモード** (`-i`オプション)
   - 変更内容の表示
   - テンプレートからの選択
   - カスタムメッセージ入力
   - 詳細追加オプション

2. **自動クリーンアップ**
   - AIシグネチャの自動除去
   - 不要な装飾の削除
   - メッセージの正規化

3. **スマートサジェスト**
   - 変更されたファイルからの推測
   - コンテキストに基づく提案
   - 過去のコミットパターン学習（将来実装）

### 3.3 Git Hooks統合

**pre-commit hook**:
- ステージングされた変更の事前検証
- 設定ファイルの読み込み
- 早期警告の提供

**prepare-commit-msg hook**:
- 最終的なメッセージ検証
- AI検出時のコミット中止
- 代替案の提示

## 4. 検出アルゴリズム詳細

### 検出レベル

```
レベル1 (必須): 明示的マーカー
├── AI署名・タグ
├── 特定の絵文字
└── 既知のbotメールアドレス

レベル2 (高確度): 構造パターン
├── Conventional Commits の過度な使用
├── 箇条書き形式（3項目以上）
└── 定型的な文章構造

レベル3 (中確度): 語彙分析
├── 形式的動詞の頻度分析
├── 技術用語密度の測定
└── 文体の一貫性評価

レベル4 (低確度): コンテキスト分析
├── 変更内容との一致度
├── メッセージ長と詳細度の相関
└── 自然言語処理による評価
```

### スコアリングシステム

各検出要素にスコアを割り当て、閾値を超えた場合にAIと判定：
- レベル1: 100ポイント（即座に検出）
- レベル2: 40-60ポイント
- レベル3: 20-30ポイント
- レベル4: 10-20ポイント

閾値: 80ポイント以上でAI判定

## 5. ユーザーインターフェース

### CLI使用例

```bash
# 基本的な使用方法
detect-ai-message "Your commit message"
detect-ai-message -f commit_message.txt

# クリーンコミット
clean-commit -m "Fix login bug"
clean-commit -i                    # インタラクティブモード
clean-commit -i -a                 # 全ファイル自動ステージング

# セットアップ
setup-hooks.sh install             # フックのインストール
setup-hooks.sh uninstall           # フックの削除
setup-hooks.sh status              # 現在の状態確認
```

### インタラクティブモードのフロー

1. 現在の変更を表示
2. ステージングの確認/実行
3. テンプレート選択または入力
4. 詳細追加（オプション）
5. AI検出チェック
6. コミット実行

## 6. 設定オプション

### `config/ai-detection.conf`

```conf
# 検出レベル設定
detection_level=medium      # low, medium, high

# 検出オプション
allow_emoji=false          # 絵文字を許可するか
check_grammar=true         # 文法チェックを行うか
check_vocabulary=true      # 語彙分析を行うか

# コミットメッセージ設定
max_message_length=72      # 最大文字数（0で無制限）
min_message_length=10      # 最小文字数
require_capital=false      # 先頭大文字を必須とするか

# 支援機能
suggest_templates=true     # テンプレート提案
interactive_by_default=false  # デフォルトでインタラクティブモード
auto_cleanup=true          # 自動クリーンアップ

# ログ設定
log_detections=true        # 検出結果をログに記録
log_file=~/.ai-commit-block.log
```

## 7. エラーハンドリング

### エラーコード
- 0: 成功（AIなし）
- 1: AI検出
- 2: 設定エラー
- 3: Git関連エラー
- 4: ファイルI/Oエラー

### エラーメッセージ
明確で実用的なエラーメッセージを提供し、次のアクションを提案

## 8. 今後の拡張計画

### Phase 1 (現在実装中)
- 基本的なAI検出機能
- シンプルなクリーンコミット支援
- Git hooks統合

### Phase 2
- 機械学習ベースの検出
- コミット履歴からの学習
- チーム設定の共有

### Phase 3
- IDE/エディタプラグイン
- CI/CD統合
- 統計レポート機能

## 9. パフォーマンス考慮事項

- 検出処理は100ms以内に完了
- メモリ使用量は10MB以下
- 大規模リポジトリでも高速動作

## 10. セキュリティ考慮事項

- 設定ファイルの適切な権限管理
- ログファイルのプライバシー保護
- 外部サービスへの依存なし